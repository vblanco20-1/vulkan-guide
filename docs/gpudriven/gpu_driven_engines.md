---
layout: default
title: Gpu Driven Rendering Overview
parent: Gpu Driven Rendering
nav_order: 1
---

![city]({{site.baseurl}}/diagrams/cityrender.png)
Tutorial codebase, 125.000 objects processed and culled on main view and shadow view, 290 FPS. This view renders more than 40 million triangles due to the 2 mesh passes. Rendered on a RTX 2080.



## GPU Driven Rendering

Over the last few years, bleeding edge render engines have been moving more and more towards calculated the rendering itself on the gpu in compute shaders.
Thanks to the introduction of MultiDrawIndirect and similar features, it's now possible to do a very big amount of the work for the rendering inside compute shaders. The benefits are clear:

* GPUs have orders of magnitude higher performance than CPU on data-parallel algorithms. Rendering is almost all data parallel algorithms.
* With the GPU deciding its own work, latencies are minimized as there is no roundtrip from cpu to gpu and back.
* Frees up the CPU from a lot of work which can now be used on other things.

The result is an order of magnitude or more scene complexity and object counts. In the code that we will walk through in later chapters, based on the engine at the end of chapter 5 tutorial, we can run 250.000 "drawcalls", on Nintendo Switch, at more than 60 fps. On PC it reaches 500 fps. We essentially have a nearly unlimited object count, with the bottleneck moved into just how many triangles are we trying to make the gpu draw.

![perf]({{site.baseurl}}/diagrams/indirectperf.png)
CPU processing takes less than 0.5 milliseconds. Same view as above. Ryzen 1700


Techniques based on compute-shader-rendering have been becoming more popular in the last 5 years. Before that, they were used more on CAD type scenes.  Famously, Assassins Creed Unity and sequels use these techniques to achieve an order of magnitude more complex scenes, with Paris having an immense amount of objects as it is also rendering interiors for a lot of buildings. Frostbite engine from EA also uses these techniques to have very high geometry detail on Dragon Age Inquisition. These techniques are also the reason Rainbow Six Siege can have  thousands of dynamic rubble objects created from its destruction systems. The techniques have become very popular on the PS4 and Xbox One generation of consoles as they are easily bottlenecked on triangle throughput, so having very accurate culling gives very great performance gains. Unreal Engine 4 and Unity do NOT use these techniques, but it looks like Unreal Engine 5 will use them.


## Draw Indirect
The core of the idea revolves around the use of Draw Indirect support in the graphics APIs. These techniques work on all graphics APIs, but they work best on Vulkan or DX12 because they allow better control over low level memory management and compute barriers. They also work great on the PS4 and Xbox One consoles and the next generation has features that leans even more into it, such as Mesh Shaders and raytracing.

Draw indirect is a drawcall that takes its parameters from a GPU buffer instead of from the call itself. When using draw indirect, you just start the draw based on a position on a gpu buffer, and then the GPU will execute the draw command in that buffer.

Pseudocode:

```cpp

//normal drawing ---------------
vkCmdDrawIndexed(cmd, object.indexCount, 1 /* instance count */,object.firstIndex, object.vertexOffset, object.ID /* firstInstance */ );

//indirect drawing ---------------

Buffer* drawBuffer = create_buffer(sizeof(VkDrawIndexedIndirectCommand));

//we can immediately enqueue the draw indirect
vkCmdDrawIndexedIndirect(cmd, drawBuffer.buffer, 0 /* offset */, 1 /* drawCount */, sizeof(VkDrawIndexedIndirectCommand));


//we can write the actual draw command at any time we want before VkQueueSubmit(), or from a different thread, or from a compute shader
VkDrawIndexedIndirectCommand* command = map_buffer(drawBuffer);

command->indexCount = object.indexCount;
command->instanceCount = 1;
command->firstIndex = object.firstIndex ;
command->vertexOffset = object.vertexOffset;
command->firstInstance = object.ID;
```

Because it takes its parameters from a buffer, it is possible to use compute shaders to write into these buffers and do culling or LOD selection in compute shaders. Doing culling this way is one of the simplest and most performant ways of doing culling. Due to the power of the GPU you can easily expect to cull more than a million objects in less than half a millisecond. Normal scenes don't tend to go as far. In more advanced pipelines like the one in Dragon Age or Rainbow Six, they go one step further and also cull individual triangles from the meshes. They do that by writing an output Index Buffer with the surviving triangles and using indirect to draw that.

When you design a gpu-driven renderer, the main idea is that all of the scene should be on the GPU. In chapter 4, we saw how to store the matrices for all loaded objects into a big SSBO. In GPU driven pipelines, we also want to store more data, such as material ID and cull bounds. Once we have a renderer where everything is stored in big GPU buffers, and we don't use PushConstants or descriptor sets per object, we are ready to go with a gpu-driven-renderer. The design of the tutorial engine is one that maps well into refactoring for a extreme performance compute based engine.

Due to the fact that you want to have as much things on the GPU as possible, this pipeline maps very well if you combine it with "Bindless" techniques, where you stop needing to bind descriptor sets per material or changing vertex buffers. In Doom Eternal engine, they go all-in on bindless, and the engine ends up doing very few drawcalls per frame. On this guide we will not use bindless textures as their support is limited, so we will do 1 draw-indirect call per material used. We will still merge all of the meshes into a big vertex buffer to avoid having to constantly bind it between draws. Having a bindless renderer also makes raytracing much more performant and effective.

## Bindless Design

![perf]({{site.baseurl}}/diagrams/novus.png)
NovusCore Wow emulation research project. An entire continent from World of Warcraft rendered in less than 10 drawcalls at 100+ FPS. Infinite draw distance.

GPU driven pipelines work best when the amount of binds is as limited as possible. Best case scenario is to do a extremely minimal amount of BindVertexBuffer, BindIndexBuffer, BindPipeline, and BindDescriptorSet calls. Bindless designs make the cpu side work a lot faster due to the CPU having to do much less work, and the GPU can also go faster due to better utilization as each drawcall is "bigger". The less drawcalls you use to render your scene, the better, as modern GPUs are really big and have a big ramp up/ramp down time. Big modern GPUs love when you give them massive amounts of work on each drawcall, as that way they can ramp up to 100% usage.

To move vertex and index buffers to bindless, generally you do it by merging the meshes into really big buffers. Instead of having 1 buffer per vertex buffer and index buffer pair, you have 1 buffer for all vertex buffers in a scene. When rendering, then you use BaseVertex offsets in the drawcalls.

In some engines, they remove vertex attributes from the pipelines entirely, and instead grab the vertex data from buffers in the vertex shader. Doing that makes it much easier to keep 1 big vertex buffer for all drawcalls in the engine even if they use different vertex attribute formats. It also allows some advanced unpacking/compression techniques, and it's the main use case for Mesh Shaders.

To move textures into bindless, you use texture arrays. With the correct extension, the size of the texture array can be unbounded in the shader, like when you use SSBOs. Then, when accessing the textures in the shader, you access them by index which you grab from another buffer. If you don't use the Descriptor Indexing extensions, you can still use texture arrays, but they will need a bounded size. Check your device limits to see how big can that be.

To make materials bindless, you need to stop having 1 pipeline per material. Instead, you want to move the material parameters into SSBOs, and go with an ubershader approach. In the Doom engines, they have a very low amount of pipelines for the entire game. Doom eternal has less than 500 pipelines, while Unreal Engine games often have 100.000+ pipelines. If you use ubershaders to massively lower the amount of unique pipelines, you will be able to increase efficiency in a huge way, as VkCmdBindPipeline is one of the most expensive calls when drawing objects in vulkan.

Push Constants and Dynamic Descriptors can be used, but they have to be "global". Using pushconstants for things like camera location is perfectly fine, but you cant use them for object ID as thats a per-object call and you specifically want to draw as many objects as possible in 1 draw.

The general workflow is to put stuff into buffers, and have big buffers so you don't need to bind them every call. The bonus is that you can also write those buffers from the GPU, which is what Dragon Age Inquisition does for Index buffers, where it writes to them from the culling shaders so that only the visible triangles get drawn.


## Links 
* Assassins Creed Unity Engine + others: [PDF Link](https://www.advances.realtimerendering.com/s2015/aaltonenhaar_siggraph2015_combined_final_footer_220dpi.pdf ) 
* Dragon Age Inquisition mesh culling: [GDC Link](https://www.gdcvault.com/play/1023109/Optimizing-the-Graphics-Pipeline-With)
* Rainbow Six Siege engine: [GDC Link](https://www.gdcvault.com/play/1022990/Rendering-Rainbow-Six-Siege)
* Doom Eternal engine: [Siggraph Link](https://advances.realtimerendering.com/s2020/RenderingDoomEternal.pdf)
* Nvidia Advanced Scenegraph:  [PDF Link](https://on-demand.gputechconf.com/gtc/2013/presentations/S3032-Advanced-Scenegraph-Rendering-Pipeline.pdf)


## Overview of Vkguide engine architecture for compute rendering.
The techniques here can be directly implemented after the 5 chapters of the core tutorial. The engine also has the things from Extra chapter implemented, but should be easy to follow. The details of the system will be explored in next chapters.

The first thing is to go all in on object data in GPU buffers. Per-object PushConstants are removed, per-object dynamic uniform buffers are removed, and everything is replaced by ObjectBuffer where we store the object matrix and we index into it from the shader.

We also change the way the meshes work. After loading a scene, we create a BIG vertex buffer, and stuff all of the meshes of the entire map into it. This way we will avoid having to rebind vertex buffers.

With the data management done, we can implement the indirect draw itself.
<div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;lightbox&quot;:false,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2020-11-26T20:00:50.085Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36\&quot; etag=\&quot;4t8WBQzfu6XBeMR7guR-\&quot; version=\&quot;13.10.4\&quot; type=\&quot;device\&quot;&gt;&lt;diagram id=\&quot;bKVgl3qcKdm3Ox6zxd8P\&quot; name=\&quot;Page-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>

We will split the renderable objects by mesh-pass. Each mesh-pass will be a specific pass in the renderer. In the tutorial, we will have 2 mesh passes, one for the forward-rendered meshes, and another one for the shadow casting. Some objects will be registered in one pass but not the other, and most will be in both passes. By separating the individual objects into multiple mesh-passes, we simplify the render loop significantly, and allow better performance.

The code that manages indirect draws is in the RenderScene class, which will grab all of the objects in a mesh-pass and sort them into batches. A Batch is a set of objects that matches material and mesh. Each batch will be rendered with one DrawIndirect call that does instanced drawing. Each mesh pass (forward pass, shadow pass, others) contains an array of batches which it will use for rendering.

In the main ObjectBuffer, we store the object matrix alongside the cull bounds per each object loaded in the engine.

When starting the frame, we sync the objects that are on each mesh pass into a buffer. This buffer will be an array of ObjectID + BatchID. The BatchID maps directly as an index into the batch array of the mesh-pass.

Once we have that buffer uploaded and synced, we execute a compute shader that performs the culling.
For every object in said array of ObjectID + BatchID pairs, we access the object data in the ObjectBuffer using the ObjectID,  and check if it is visible.
If it's visible, we use the BatchID index to insert the draw into the Batches array, which contains the draw indirect calls, increasing the instance count. We also write it into the indirection buffer that maps from the instance ID of each batch into the ObjectID.

With that done, on the CPU side we iterate over the batches in a mesh pass, and execute each of them in order, making sure to bind each batch pipeline and material descriptor set. The gpu will then use the parameters it just wrote into from the culling pass to render the objects.


{: .fs-6 .fw-300 }
{% include comments.html term="GPU Driven Rendering" %}